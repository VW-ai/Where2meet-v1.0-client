<!DOCTYPE html>
<html>
<head>
  <title>Clear Invalid Tokens</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
    .section { margin: 20px 0; padding: 15px; background: #2d2d2d; border-left: 3px solid #f48771; }
    button { background: #f48771; color: white; border: none; padding: 10px 20px; cursor: pointer; margin: 5px; }
    button:hover { background: #e07060; }
    .warning { color: #dcdcaa; background: #3c3c3c; padding: 10px; margin: 10px 0; }
    .success { color: #4ec9b0; }
  </style>
</head>
<body>
  <h1>⚠️ Clear Invalid Tokens</h1>

  <div class="warning">
    <strong>⚠️ WARNING:</strong> This will clear ALL event tokens from localStorage.
    <br><br>
    You will lose access to any unclaimed events. You'll need to create new events.
    <br><br>
    <strong>Why?</strong> The tokens in localStorage don't match the backend database (hash mismatch).
    <br>
    The backend stores SHA-256 hashes, and your current tokens don't have matching hashes in the database.
  </div>

  <div class="section">
    <h2>Step 1: Review What Will Be Deleted</h2>
    <button onclick="scanTokens()">Scan Tokens</button>
    <div id="scan-output"></div>
  </div>

  <div class="section">
    <h2>Step 2: Clear All Event Tokens</h2>
    <button onclick="clearAllTokens()">Clear All Tokens</button>
    <div id="clear-output"></div>
  </div>

  <div class="section">
    <h2>Step 3: Verify Clean State</h2>
    <button onclick="verifyClean()">Verify</button>
    <div id="verify-output"></div>
  </div>

  <script>
    function scanTokens() {
      const output = document.getElementById('scan-output');

      const tokenKeys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.includes('token') || key.includes('participant_id'))) {
          tokenKeys.push(key);
        }
      }

      if (tokenKeys.length === 0) {
        output.innerHTML = '<div class="success">✅ No tokens found</div>';
        return;
      }

      let html = `<h3>Found ${tokenKeys.length} token-related items:</h3><ul>`;
      tokenKeys.forEach(key => {
        const value = localStorage.getItem(key);
        html += `<li><strong>${key}:</strong> ${value?.substring(0, 30)}...</li>`;
      });
      html += '</ul>';

      output.innerHTML = html;
    }

    function clearAllTokens() {
      const output = document.getElementById('clear-output');

      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (
          key.startsWith('organizer_token_') ||
          key.startsWith('participant_token_') ||
          key.startsWith('organizer_participant_id_') ||
          key.startsWith('participant_id_')
        )) {
          keysToRemove.push(key);
        }
      }

      if (keysToRemove.length === 0) {
        output.innerHTML = '<div class="success">✅ No tokens to clear</div>';
        return;
      }

      keysToRemove.forEach(key => localStorage.removeItem(key));

      output.innerHTML = `
        <div class="success">
          <h3>✅ Cleared ${keysToRemove.length} items</h3>
          <p>Removed keys:</p>
          <ul>${keysToRemove.map(k => `<li>${k}</li>`).join('')}</ul>
        </div>
      `;
    }

    function verifyClean() {
      const output = document.getElementById('verify-output');

      const remainingTokens = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.includes('token') || key.includes('participant_id'))) {
          remainingTokens.push(key);
        }
      }

      if (remainingTokens.length === 0) {
        output.innerHTML = `
          <div class="success">
            <h3>✅ Clean State Verified</h3>
            <p>No event tokens remaining in localStorage.</p>
            <p><strong>Next steps:</strong></p>
            <ol>
              <li>Reload your app</li>
              <li>Create a new event while logged in</li>
              <li>It should automatically appear in your dashboard</li>
            </ol>
          </div>
        `;
      } else {
        output.innerHTML = `
          <div style="color: #dcdcaa;">
            <h3>⚠️ Some tokens still remain:</h3>
            <ul>${remainingTokens.map(k => `<li>${k}</li>`).join('')}</ul>
            <p>Try clearing again.</p>
          </div>
        `;
      }
    }

    // Auto-scan on load
    window.onload = () => scanTokens();
  </script>
</body>
</html>
